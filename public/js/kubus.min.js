jQuery(document).ready(function(a){function x(b){k();b.hasClass("chosen")||(a(".buildOption").removeClass("chosen"),b.toggleClass("chosen"),c.toggleBuildMode())}function m(b){var f=b.attr("href"),d=f!==t;k();if(d){if("#save"==f||"#import"==f)"#save"==f?a("#Submit").text("Spara"):a("#Submit").text("H\u00e4mta"),f="#FormModal",navigator.userAgent.match(/(iPad|iPhone|iPod touch);.*CPU.*OS 7_\d/i)&&(a("#modal").css({position:"absolute",marginTop:a(window).scrollTop()+"px",bottom:"auto"}),setTimeout(function(){a("#modal").css({height:Math.max(document.body.scrollHeight,
document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight)+"px"})},0));"#help"==f&&(f="#helpModal");a("#modal").toggleClass("open");a(f).toggleClass("open");a("#alert").text("");a(".modalOption").toggleClass("faded");b.removeClass("faded");t=f;c.enableOrDisableOrbit(!1)}}function k(){a(t).removeClass("open");a("#modal").removeClass("open");a(".modalOption").removeClass("faded");a("#alert").removeClass("sadSmiley");
a("#alert").removeClass("happySmiley");a("#Name").val("");t=null;c.enableOrDisableOrbit(!0)}var d=[a("#topView"),a("#blueView"),a("#redView"),a("#yellowView"),a("#greenView"),a("#preview")],g=[];a("#colorsModal a").each(function(b,c){"#random"!=a(c).attr("href")&&g.push(a(c).attr("href"))});var c=new BUILDER.ConstructionArea(a("#ThreeJScontainer"),d,g);c.renderPerspectives();var t=null,q;document.querySelector("#ThreeJScontainer").addEventListener("mousedown",function(){"#random"==q&&c.setCubeMaterial(g[Math.floor(Math.random()*
(g.length-1))])});a("#toggleCounter").on("click",function(b){b.preventDefault();"\u2192"===a("#toggleArrow").text()?(a("#toggleArrow").text("\u2190"),a(".counter").show()):"\u2190"===a("#toggleArrow").text()&&(a("#toggleArrow").text("\u2192"),a(".counter").hide())});a("#menu").on("click","a",function(b){b.preventDefault();a(this).hasClass("buildOption")?x(a(this)):(m(a(this)),c.renderPerspectives())});a("#perspectives").on("click","a",function(a){a.preventDefault()});a("#togglePerspectiveLandscape").on("click",
function(b){b.preventDefault();b=a("#togglePerspectiveLandscape");var f=a("#perspectives");b.hasClass("open")?(f.hide(),c.shouldRenderPerspectives(!1),b.attr("class","close"),b.text("\u2190")):(f.show(),c.shouldRenderPerspectives(!0),b.attr("class","open"),b.text("\u2192"))});a("#togglePerspectivePortrait").on("click",function(b){b.preventDefault();b=a("#togglePerspectivePortrait");var f=a("#perspectives");b.hasClass("open")?(f.hide(),c.shouldRenderPerspectives(!1),b.attr("class","close"),b.text("\u2191")):
(f.show(),c.shouldRenderPerspectives(!0),b.attr("class","open"),b.text("\u2193"))});a("#modal").click(function(a){"DIV"==a.target.tagName&&k()});a("#modal").on("click","a",function(b){b.preventDefault();if(a(this).hasClass("color"))b=a(this).attr("href"),void 0!=q&&a("#cube").removeClass("color-"+q.substring(1)),q=b,a("#cube").addClass("color-"+q.substring(1)),"#random"==b&&(b=g[Math.floor(Math.random()*(g.length-1))]),c.setCubeMaterial(b),x(a("#cube")),k();else if(a(this).hasClass("sizeControl"))a:{b=
a(this).attr("href");var f=c.getBaseSize();switch(b){case "#up":if(10>f)f=parseInt(f)+1;else break a;break;case "#down":if(1<f)f=parseInt(f)-1;else break a}a("#sizePreview").text(f);c.setBaseSize(f);c.renderPerspectives();a("#ThreeJScontainer").trigger("updateView")}else if(a(this).hasClass("perspective"))setPerspective(a(this));else{if("#import"==a(this).attr("href")||"#save"==a(this).attr("href"))m(a(this)),a("#Name").focus();"#print"==a(this).attr("href")&&(k(),window.print());"#reset"==a(this).attr("href")&&
(c.clearCubes(),c.renderPerspectives(),a("#ThreeJScontainer").trigger("updateView"),k());"#help"==a(this).attr("href")&&m(a(this))}});navigator.onLine&&a("#formOfflineInfo").hide();a(window).on("online",function(b){a("#formOfflineInfo").hide()});a(window).on("offline",function(b){a("#formOfflineInfo").show()});a("#Submit").on("click",function(b){b.preventDefault();a("#saveImportForm").submit()});a("#saveImportForm").on("submit",function(b){b.preventDefault();var f=a.trim(a("#Name").val()),d=new BUILDER.BuildingSaver,
m=a("#alert");if(""==f||null==f||void 0==f)m.text("Namnet \u00e4r f\u00f6r kort"),a("#alert").attr("class","sadSmiley");else if(50>=f.length)if("H\u00e4mta"==a("#Submit").text())navigator.onLine?a.ajax({type:"GET",url:"api/"+f,statusCode:{200:function(a){d.saveNewBuilding(f,a.data.model,!1);c.loadModel(a.data);k()},400:function(b){(b=d.getBuilding(f))?(c.loadModel(b),k()):(m.text("Byggnaden hittades inte"),a("#alert").attr("class","sadSmiley"))},404:function(b){m.text("Ett fel intr\u00e4ffade, f\u00f6rs\u00f6k igen");
a("#alert").attr("class","sadSmiley")},500:function(b){m.text("Ett fel intr\u00e4ffade, f\u00f6rs\u00f6k igen");a("#alert").attr("class","sadSmiley")},503:function(b){m.text("Ett fel intr\u00e4ffade, f\u00f6rs\u00f6k igen");a("#alert").attr("class","sadSmiley")}}}):(b=d.getBuilding(f))?(c.loadModel(b),k()):(m.text("Byggnaden hittades inte"),a("#alert").attr("class","sadSmiley"));else{b="api/create";var g=LZString.decompressFromBase64(c.saveModel());navigator.onLine?a.ajax({type:"POST",url:b,data:{name:f,
model:g},statusCode:{201:function(b){d.saveBuildings(JSON.parse(b.data));m.text("Byggnaden sparades");a("#alert").attr("class","happySmiley");a("#Name").val("")},400:function(b){m.text("Namnet finns redan");a("#alert").attr("class","sadSmiley")},404:function(b){m.text("Ett fel intr\u00e4ffade, f\u00f6rs\u00f6k igen");a("#alert").attr("class","sadSmiley")},500:function(b){m.text("Ett fel intr\u00e4ffade, f\u00f6rs\u00f6k igen");a("#alert").attr("class","sadSmiley")},503:function(b){m.text("Ett fel intr\u00e4ffade, f\u00f6rs\u00f6k igen");
a("#alert").attr("class","sadSmiley")}}}):d.saveNewBuilding(f,g,!0)?(m.text("Byggnaden sparades lokalt"),a("#alert").attr("class","happySmiley"),a("#Name").val("")):(m.text("Namnet finns redan"),a("#alert").attr("class","sadSmiley"))}else m.text("Namnet \u00e4r f\u00f6r l\u00e5ngt"),a("#alert").attr("class","sadSmiley");return!1});a(window).resize(function(a){c.resize()});navigator.userAgent.match(/(iPad|iPhone|iPod touch);.*CPU.*OS 7_\d/i)&&a('<div style="font-weight:bold;margin-bottom:2%">P.g.a. iOS7 kan du uppleva problem med funktionerna Spara/H\u00e4mta.</div>').insertBefore(a("#formOfflineInfo"))});
(function(a){a.BUILDER=a.BUILDER||{};var x=a.BUILDER;x.ConstructionArea=function(a,k,d){function g(){y.maxDistance=e/2*20;y.minDistance=e;y.reset()}function c(a){if(Math.round(a.point.z)<e&&Math.round(a.point.z)>0-e&&Math.round(a.point.x)<e&&Math.round(a.point.x)>0-e&&Math.round(a.point.y)<e/(n/2)*n){var h=new THREE.Mesh(G,u),b=a.face.normal.clone().multiplyScalar(n/2);h.position.copy(a.point).add(b);0!==e/(n/2)%2?(a=h.position.y,h.position.divideScalar(n).round().multiplyScalar(n),h.position.y=Math.abs(Math.floor(a/
n)*n+n/2)):h.position.divideScalar(n).floor().multiplyScalar(n).addScalar(n/2);0<h.position.y&&!t(h.position)&&(v.add(h),l.push(h),r=6,setTimeout(function(){B()},0))}}function t(a){for(var h=1;h<l.length;h++)if(a.equals(l[h].position))return!0;return!1}function q(){var z=new THREE.PerspectiveCamera(45,a.width()/a.height(),1,1E4);z.position.set(500,800,1300);z.lookAt(new THREE.Vector3);return z}function b(){var a=[],h=e/7,b=new THREE.Geometry;b.vertices.push(new THREE.Vector3(e+h,0,e));b.vertices.push(new THREE.Vector3(e+
h,0,-e));var c=new THREE.LineBasicMaterial({color:39236,linewidth:2});a.push(new THREE.Line(b,c,THREE.LinePieces));b=new THREE.Geometry;b.vertices.push(new THREE.Vector3(-(e+h),0,e));b.vertices.push(new THREE.Vector3(-(e+h),0,-e));c=new THREE.LineBasicMaterial({color:14842878,linewidth:2});a.push(new THREE.Line(b,c,THREE.LinePieces));b=new THREE.Geometry;b.vertices.push(new THREE.Vector3(e,0,e+h));b.vertices.push(new THREE.Vector3(-e,0,e+h));c=new THREE.LineBasicMaterial({color:26807,linewidth:2});
a.push(new THREE.Line(b,c,THREE.LinePieces));b=new THREE.Geometry;b.vertices.push(new THREE.Vector3(e,0,-(e+h)));b.vertices.push(new THREE.Vector3(-e,0,-(e+h)));c=new THREE.LineBasicMaterial({color:15964160,linewidth:2});a.push(new THREE.Line(b,c,THREE.LinePieces));return a}function f(){function a(b,z,c,f){var d=f.width()/f.height(),d=new THREE.OrthographicCamera(1200*d/2,1200*-d/2,600,-600);d.position.set(b,z,c);d.lookAt(new THREE.Vector3(0,e,0));b=M(f);return new x.View(b,d,f,v,e)}p=[];p.push(a(0,
1600,0,k[0]));p.push(a(0,e,e,k[1]));p.push(a(-e,e,0,k[2]));p.push(a(0,e,-e,k[3]));p.push(a(e,e,0,k[4]));k[5]&&p.push(a(0,1600,0,k[5]));p.forEach(function(a,b,z){a.init()})}function M(a,b){var c;c=b?Detector.webgl?new THREE.WebGLRenderer({antialias:!0,alpha:!0,preserveDrawingBuffer:!0}):new THREE.CanvasRenderer({alpha:!0}):new THREE.CanvasRenderer({alpha:!0});c.setClearColor(0,0);c.setPixelRatio(window.devicePixelRatio||1);c.setSize(a.width(),a.height());return c}function F(){var a=new THREE.Scene;
a.add(P);a.add(H);b().forEach(function(b,c,e){a.add(b)});return a}function O(a){a.object!=H&&(v.remove(a.object),l.splice(l.indexOf(a.object),1),r=6,setTimeout(function(){B()},0))}function N(){requestAnimationFrame(N);C.render(v,A)}function I(){for(var a=new THREE.Geometry,b=-e;b<=e;b+=n)a.vertices.push(new THREE.Vector3(-e,0,b)),a.vertices.push(new THREE.Vector3(e,0,b)),a.vertices.push(new THREE.Vector3(b,0,-e)),a.vertices.push(new THREE.Vector3(b,0,e));b=new THREE.LineBasicMaterial({color:0,opacity:.2,
transparent:!0});P=new THREE.Line(a,b,THREE.LinePieces);a=new THREE.PlaneBufferGeometry(2*e,2*e);a.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2));a=new THREE.Mesh(a);a.visible=!1;H=l[0]=a}function B(){var a=1==l.length?"0":l.length-1,b=$("#counter");b.length&&b.text(a)}function Q(b){b.preventDefault();var h=b.pageX-a.offset().left,e=b.pageY-a.offset().top;if("mousedown"===b.type)D.x=h,D.y=e;else if("mouseup"===b.type&&D.x==h&&D.y==e&&(J.set(h/a.width()*2-1,2*-(e/a.height())+1),K.setFromCamera(J,
A),h=K.intersectObjects(l),0<h.length))switch(h=h[0],b.button){case 0:L?c(h):O(h);break;case 2:O(h)}}var n,e,l,G,v,A,C,u,K,D,J,P,H,y,p,L=!0,E=this,S=d||[],R={},w={},r=0;this.perspective=function(a){};this.clearCubes=function(){for(var a=1;a<l.length;a++)v.remove(l[a]);l.splice(1,l.length);B()};this.enableOrDisableOrbit=function(a){return"boolean"===typeof a?(y.enabled=a,!0):!1};this.loadModel=function(a){var b,c=u;a="object"===typeof a?a:JSON.parse(a);a=JSON.parse(LZString.decompressFromBase64(a.model));
l=[];e=n/2*a.baseSize;I();v=F();for(var d=0,g=a.cubes.length;d<g;d++)b="#"+a.cubes[d].color,E.setCubeMaterial(b),b=new THREE.Mesh(G,w[b]),b.position.x=a.cubes[d].x,b.position.y=a.cubes[d].y,b.position.z=a.cubes[d].z,v.add(b),l.push(b);B();f();E.renderPerspectives();u=c};this.renderPerspectives=function(){p.forEach(function(a,b,c){a.setSize();a.render()})};this.resize=function(){A.aspect=a.width()/a.height();A.updateProjectionMatrix();C.setSize(a.width(),a.height());E.renderPerspectives()};this.saveModel=
function(){function a(b,c,d,e){this.color=b;this.x=c;this.y=d;this.z=e}for(var b={baseSize:l[0].geometry.parameters.height/n,cubes:[],step:n/2},c=1;c<l.length;c++){var d=l[c].material.map.sourceFile,d=d.replace("public/img/textures/",""),d=d.replace(".png","");b.cubes.push(new a(d,l[c].position.x,l[c].position.y,l[c].position.z))}return LZString.compressToBase64(JSON.stringify(b))};this.setBaseSize=function(a){return!isNaN(a)&&1<=a&&10>=a?(e=n/2*a,l=[],I(),g(),v=F(),f(),B(),!0):!1};this.getBaseSize=
function(){return e/(n/2)};this.setCubeMaterial=function(a){return/^#([A-Fa-f0-9]{6})$/.test(a)?(Detector.webgl?void 0==w[a]?(u=new THREE.MeshBasicMaterial({map:R[a.toUpperCase()]||THREE.ImageUtils.loadTexture("public/img/textures/"+a.toUpperCase().substring(1)+".png")}),w[a]=u):u=w[a]:void 0==w[a]?(u=new THREE.MeshBasicMaterial({color:a}),w[a]=u):u=w[a],!0):!1};this.toggleBuildMode=function(){L=!L};this.shouldRenderPerspectives=function(a){p.forEach(function(b){b.shouldRender(a)});p[5].shouldRender(!0);
a&&(r=6)};(function(){if(!(a instanceof jQuery))throw Error();for(var b=0;b<k.length;b++)if(!(k[b]instanceof jQuery))throw Error();S.forEach(function(a){requestAnimationFrame(function(){THREE.ImageUtils.loadTexture("public/img/textures/"+a.toUpperCase().substring(1)+".png",void 0,function(b){R[a]=b})})});E.setCubeMaterial("#FBE430");jQuery.Event("updateView");n=50;l=[];p=[];G=new THREE.BoxGeometry(n,n,n);K=new THREE.Raycaster;D=new THREE.Vector2;J=new THREE.Vector2;e=250;I();v=F();A=q();C=M(a,!0);
y=new THREE.OrbitControls(A,C.domElement);y.noPan=!0;g();a.append(C.domElement);a[0].addEventListener("mousedown",Q);a[0].addEventListener("mouseup",Q);f();setTimeout(function(){N()},300)})();setInterval(function(){requestAnimationFrame(function(){0<r&&p[0].render()&&r--})},400);setInterval(function(){requestAnimationFrame(function(){0<r&&p[1].render()&&r--})},400);setInterval(function(){requestAnimationFrame(function(){0<r&&p[2].render()&&r--})},400);setInterval(function(){requestAnimationFrame(function(){0<
r&&p[3].render()&&r--})},400);setInterval(function(){requestAnimationFrame(function(){0<r&&p[4].render()&&r--})},400);setInterval(function(){requestAnimationFrame(function(){0<r&&p[5].render()&&r--})},400)};x.View=function(a,k,d,g,c){var t=!0;this.render=function(){return t?(a.render(g,k),!0):!1};this.setSize=function(){var g=2*c-10;"topView"==d.attr("id")?g=2*c+c/20:"preview"==d.attr("id")&&(g=2*c+c/2);var b=d.width()/d.height();a.setSize(d.width(),d.height());k.left=b*g/2;k.right=-b*g/2;k.top=g/
2;k.bottom=-g/2;k.updateProjectionMatrix()};this.init=function(){d.empty();d.append(a.domElement)};this.shouldRender=function(a){t=a}}})(window);jQuery(document).ready(function(){$(window.applicationCache).on("updateready",function(a){window.applicationCache.swapCache()})});
(function(a){a.BUILDER=a.BUILDER||{};a.BUILDER.BuildingSaver=function(){function a(d,g){for(var c in g)if(c=c.trim().toLowerCase(),d=d.trim().toLowerCase(),c==d)return!0;return!1}function m(){return localStorage.getItem("buildings")?JSON.parse(localStorage.getItem("buildings")):!1}var k=this;this.getBuilding=function(a){var g=m();a=a.trim().toLowerCase();return g?g[a]:!1};this.saveBuildings=function(d){var g=m()||{},c;for(c in d)c=c.trim().toLowerCase(),a(c,g)||(g[c]=d[c]);d={};c=0;for(var k in g){var q=
new Date((new Date(g[k].date)).getTime()+2592E6),b=new Date;b.setHours(0,0,0,0);if(q>=b.getTime()){if(250<=c)break;d[k]=g[k];c+=1}}localStorage.setItem("buildings",JSON.stringify(d))};this.saveNewBuilding=function(d,g,c){d=d.trim().toLowerCase();if(a(d,m()))return!1;var t={};c&&(g=LZString.compressToBase64(g));var q=new Date;c=q.getDate();10>c&&(c="0"+c);var b=q.getMonth()+1;10>b&&(b="0"+b);q=q.getFullYear();t[d]={model:g,date:q+"-"+b+"-"+c};k.saveBuildings(t);return!0}}})(window);